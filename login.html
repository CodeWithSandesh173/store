<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Dev Sandesh Store</title>
    <link rel="icon" href="Images/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        .hidden-fields {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-dark);
            border: 1px solid var(--primary);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .logo-img {
            width: 80px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <!-- Forgot Password Modal -->
    <div id="forgotModal" class="modal">
        <div class="modal-content">
            <h3>Reset Password</h3>
            <p style="color:var(--text-muted); margin: 10px 0;">Enter your email to receive a reset link.</p>
            <input type="email" id="resetEmail" placeholder="Enter email"
                style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px; border:none;">
            <button onclick="sendResetLink()" class="btn btn-primary">Send Link</button>
            <button onclick="closeModal()" class="btn btn-outline" style="margin-top:10px;">Cancel</button>
            <p id="resetMsg" style="margin-top:10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div class="container">
        <div class="auth-container" style="text-align: center;">
            <img src="Images/icon.png" alt="Logo" class="logo-img">
            <h2 id="formTitle" style="margin-bottom: 30px; font-size: 2rem;">Login</h2>

            <form id="authForm" style="text-align: left;">

                <!-- Extra fields for Sign Up -->
                <div class="form-group hidden-fields" id="usernameField">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="e.g. ProGamer123">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" required placeholder="name@example.com">
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required placeholder="••••••••">
                </div>

                <div class="form-group hidden-fields" id="confirmPassField">
                    <label>Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="••••••••">
                </div>

                <div class="form-group hidden-fields" id="termsField">
                    <div style="display: flex; gap: 10px; align-items: start;">
                        <input type="checkbox" id="termsCheck" style="width: auto; margin-top: 5px;">
                        <label style="display: inline; font-size: 0.8rem; line-height: 1.4;">
                            I agree to the Terms & Conditions. I understand delivery may take up to 48 hours.
                        </label>
                    </div>
                </div>

                <div style="text-align: right; margin-bottom: 20px;" id="forgotLink">
                    <a href="#" onclick="openModal()" style="font-size: 0.8rem; color: var(--primary);">Forgot
                        Password?</a>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Continue</button>
            </form>

            <p style="text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 0.9rem;">
                <span id="toggleText">New here?</span>
                <a href="#" id="toggleBtn" style="color: var(--primary); font-weight: bold;">Create Account</a>
            </p>
            <p id="errorMsg" style="color: #ff4d4d; text-align: center; margin-top: 15px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script>
        const authForm = document.getElementById('authForm');
        const formTitle = document.getElementById('formTitle');
        const toggleBtn = document.getElementById('toggleBtn');
        const toggleText = document.getElementById('toggleText');
        const errorMsg = document.getElementById('errorMsg');

        // Fields
        const usernameField = document.getElementById('usernameField');
        const confirmPassField = document.getElementById('confirmPassField');
        const termsField = document.getElementById('termsField');
        const forgotLink = document.getElementById('forgotLink');

        let isLogin = true;

        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            if (isLogin) {
                // Swith directly to Login UI
                formTitle.textContent = 'Login';
                toggleText.textContent = 'New here?';
                toggleBtn.textContent = 'Create Account';

                usernameField.classList.add('hidden-fields');
                confirmPassField.classList.add('hidden-fields');
                termsField.classList.add('hidden-fields');
                forgotLink.style.display = 'block';
            } else {
                // Switch to Register UI
                formTitle.textContent = 'Join Us';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Login';

                usernameField.classList.remove('hidden-fields');
                confirmPassField.classList.remove('hidden-fields');
                termsField.classList.remove('hidden-fields');
                forgotLink.style.display = 'none';
            }
            errorMsg.textContent = '';
        });

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            errorMsg.textContent = 'Processing...';

            if (isLogin) {
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        window.location.href = "index.html";
                    })
                    .catch((error) => {
                        errorMsg.textContent = error.message;
                    });
            } else {
                // Validations
                const username = document.getElementById('username').value;
                const confirmPass = document.getElementById('confirmPassword').value;
                const termsCheck = document.getElementById('termsCheck').checked;

                if (!username) { errorMsg.textContent = "Username is required"; return; }
                if (password !== confirmPass) { errorMsg.textContent = "Passwords do not match"; return; }
                if (!termsCheck) { errorMsg.textContent = "You must agree to the terms"; return; }

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        user.updateProfile({
                            displayName: username
                        }).then(() => {
                            user.sendEmailVerification().then(() => {
                                alert("Account created! Verification email sent.");
                                window.location.href = "index.html";
                            });
                        });
                    })
                    .catch((error) => {
                        errorMsg.textContent = error.message;
                    });
            }
        });

        // Modal Logic
        const modal = document.getElementById('forgotModal');
        function openModal() { modal.style.display = 'flex'; }
        function closeModal() { modal.style.display = 'none'; }

        function sendResetLink() {
            const email = document.getElementById('resetEmail').value;
            if (!email) return;
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    document.getElementById('resetMsg').textContent = "Link sent! Check your inbox.";
                    document.getElementById('resetMsg').style.color = "#00ff00";
                })
                .catch((error) => {
                    document.getElementById('resetMsg').textContent = error.message;
                    document.getElementById('resetMsg').style.color = "#ff4d4d";
                });
        }
    </script>
</body>

</html>