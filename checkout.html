<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Dev Sandesh Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>

<body>

    <div class="container">
        <!-- Breadcrumb-ish -->
        <div style="padding: 20px 0;">
            <a href="index.html" style="color: var(--text-muted);">&larr; Back to Home</a>
        </div>

        <div id="mainGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap:50px; padding-bottom: 50px;">

            <!-- Left: Order Details & Payment -->
            <div id="leftColumn">
                <h2 style="margin-bottom: 20px;">Order Summary</h2>
                <div
                    style="background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 30px;">
                    <h3 id="itemName">Product Name</h3>
                    <p id="itemPackage" style="color: var(--primary); font-size: 1.2rem; margin: 10px 0;">Package info
                    </p>
                    <hr style="border-color: var(--border); margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold;">
                        <span>Total:</span>
                        <span id="totalPrice">Rs. 0</span>
                    </div>
                </div>

                <h2 style="margin-bottom: 20px;" id="paymentHeader">Payment Method</h2>
                <div id="paymentQR"
                    style="text-align: center; background: #fff; padding: 20px; border-radius: 15px; max-width: 300px; margin: 0 auto;">
                    <p style="color: #000; margin-bottom: 15px; font-weight: bold;">Scan to Pay</p>
                    <img src="Images/qr.png" alt="QR Code" style="width: 100%; max-width: 250px;">
                    <p style="color: #666; font-size: 0.8rem; margin-top: 10px;">Accepts all Payment Method</p>
                </div>
            </div>

            <!-- Right: User Details Form -->
            <div>
                <h2 style="margin-bottom: 20px;">Complete Details</h2>

                <!-- Restricted Message Container -->
                <div id="restrictedMsg"
                    style="display: none; background: var(--card-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--accent); text-align: center;">
                    <h3 style="margin-bottom: 15px;">Order via Social Media</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        For this product, we only accept orders through our Instagram.
                    </p>
                    <a href="https://www.instagram.com/devstorenepal/" target="_blank" class="btn btn-primary">
                        Message on Instagram
                    </a>
                </div>

                <!-- Checkout Form -->
                <form id="orderForm"
                    style="display: block; background: var(--card-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--border);">

                    <!-- Dynamic Input based on product type -->
                    <div class="form-group">
                        <label id="targetLabel">Player ID / Email</label>
                        <input type="text" id="targetInput" required placeholder="Enter ID here">
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">Double check this! We
                            are not responsible for wrong IDs.</small>
                    </div>

                    <!-- Password Field (Initially Hidden) -->
                    <div class="form-group" id="passwordGroup" style="display: none;">
                        <label>Password</label>
                        <input type="password" id="targetPassword" placeholder="Enter your Microsoft Password">
                        <small style="color: #ff4d4d; display: block; margin-top: 5px;">Required for Minecraft
                            Topup.</small>
                    </div>

                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="accountNumber" required
                            placeholder="Enter the account number used for payment">
                    </div>

                    <div class="form-group">
                        <label>Transaction ID</label>
                        <input type="text" id="txnId" required placeholder="Enter the payment transaction ID">
                    </div>

                    <div class="form-group">
                        <label>Payment Screenshot Link (ImgBB)</label>
                        <input type="url" id="paymentProofUrl" required placeholder="Paste ImgBB link here">
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                            Please upload your screenshot to <a href="https://imgbb.com" target="_blank"
                                style="color: var(--primary);">imgbb.com</a> and paste the link here.
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Your Email (For receipt/contact)</label>
                        <input type="email" id="userEmail" required>
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px; align-items: start;">
                        <input type="checkbox" required style="width: auto; margin-top: 5px;">
                        <label style="display: inline; font-size: 0.9rem;">I agree that delivery may take up to 48
                            hours. If delayed further, I am eligible for a refund.</label>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Submit
                        Order</button>
                    <p id="orderStatus" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
                </form>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container" style="text-align: center;">
            <p>&copy; 2026 Dev Sandesh Store. All rights reserved.</p>
            <div style="margin: 15px 0;">
                <a href="https://discord.gg/TbBqXaVsJs" target="_blank"
                    style="color: #fff; margin: 0 10px; text-decoration: none;">Join Discord</a>
                |
                <a href="https://www.instagram.com/devstorenepal/" target="_blank"
                    style="color: #fff; margin: 0 10px; text-decoration: none;">Follow on Instagram</a>
            </div>
            <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.6;">Delivery within 48 hours guaranteed or full
                refund.</p>
        </div>
    </footer>

    <script>
        // Firebase Configuration (Inline)
        const firebaseConfig = {
            apiKey: "AIzaSyCqr_EYuOP_CNkh84Wbqg5NkvNVuAB6nnU",
            authDomain: "dev-sandesh-uc.firebaseapp.com",
            databaseURL: "https://dev-sandesh-uc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dev-sandesh-uc",
            storageBucket: "dev-sandesh-uc.firebasestorage.app",
            messagingSenderId: "438328231734",
            appId: "1:438328231734:web:75962e83c4ca8361825597",
            measurementId: "G-XDVPGH16J3"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.database();
        // storage not needed for link upload
    </script>
    <script src="js/data.js"></script>
    <script>
        // 1. Parse URL Data
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const pkgLabel = urlParams.get('pkgLabel');
        const pkgPrice = urlParams.get('pkgPrice');

        const product = products[productId];

        if (!product || !pkgLabel) {
            window.location.href = 'index.html';
        }

        // 2. Render Summary
        document.getElementById('itemName').textContent = product.name;
        document.getElementById('itemPackage').textContent = pkgLabel;
        document.getElementById('totalPrice').textContent = `Rs. ${pkgPrice}`;

        // 3. Product Restriction Check (ONLY PUBG & FREEFIRE)
        // const allowedIds = ['pubg', 'freefire'];
        // if (!allowedIds.includes(productId)) {
        //     // Hide form, show social media message
        //     document.getElementById('orderForm').style.display = 'none';
        //     document.getElementById('restrictedMsg').style.display = 'block';
        //     // Also hide payment method section
        //     document.getElementById('paymentHeader').style.display = 'none';
        //     document.getElementById('paymentQR').style.display = 'none';
        // }

        // 4. Dynamic Label & Fields
        const targetLabel = document.getElementById('targetLabel');
        const targetInput = document.getElementById('targetInput');
        const passwordGroup = document.getElementById('passwordGroup');
        const targetPassword = document.getElementById('targetPassword');

        if (productId === 'minecraft') {
            targetLabel.textContent = "Microsoft Email";
            targetInput.placeholder = "Enter Microsoft Email";
            passwordGroup.style.display = 'block';
            targetPassword.required = true;
        } else if (productId === 'netflix') {
            targetLabel.textContent = "Netflix Account Email";
            targetInput.placeholder = "Enter account email to topup";
            passwordGroup.style.display = 'none';
            targetPassword.required = false;
        } else if (product.type === 'key' || product.type === 'code' || product.type === 'subscription') {
            targetLabel.textContent = "Email Address for Delivery";
            targetInput.placeholder = "Where should we send the code?";
            passwordGroup.style.display = 'none';
            targetPassword.required = false;
        } else {
            targetLabel.textContent = "Player ID / UID";
            targetInput.placeholder = "Enter your in-game ID";
            passwordGroup.style.display = 'none';
            targetPassword.required = false;
        }

        // 5. Handle Auth (Autofill email if logged in)
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('userEmail').value = user.email;
            }
        });

        // 6. Handle Submit
        const orderForm = document.getElementById('orderForm');
        const orderStatus = document.getElementById('orderStatus');
        const proofUrlInput = document.getElementById('paymentProofUrl');

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const targetVal = targetInput.value;
            const passwordVal = targetPassword.value;
            const txnId = document.getElementById('txnId').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const contactEmail = document.getElementById('userEmail').value;
            const proofUrl = proofUrlInput.value;

            // Extra Validation for Minecraft
            if (productId === 'minecraft' && !passwordVal) {
                alert("Password is required for Minecraft orders.");
                return;
            }

            // Validation
            if (!targetVal || !txnId || !accountNumber || !contactEmail || !proofUrl) {
                alert("Please fill all fields and provide the ImgBB link.");
                return;
            }

            orderStatus.textContent = "Submitting Order...";
            orderStatus.style.color = "var(--primary)";
            document.querySelector('button[type="submit"]').disabled = true;

            try {
                const orderData = {
                    productId: productId,
                    productName: product.name,
                    package: pkgLabel,
                    price: pkgPrice,
                    targetId: targetVal,
                    // If password exists, include it
                    targetPassword: passwordVal || null,
                    txnId: txnId,
                    accountNumber: accountNumber,
                    contactEmail: contactEmail,
                    screenshotUrl: proofUrl,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                };

                await db.ref('orders').push(orderData);
                window.location.href = "order-success.html";

            } catch (error) {
                console.error(error);
                orderStatus.textContent = "Error: " + error.message;
                orderStatus.style.color = "#ff4d4d";
                document.querySelector('button[type="submit"]').disabled = false;
            }
        });
    </script>
</body>

</html>
